<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Adnan Jinnah">
<meta name="dcterms.date" content="2022-10-25">

<title>RvCode - fast.ai Lesson 11</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">RvCode</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/exiomius/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">fast.ai Lesson 11</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">fastai</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Adnan Jinnah </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 25, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro"><span class="toc-section-number">1</span>  Intro</a></li>
  <li><a href="#lesson-overview" id="toc-lesson-overview" class="nav-link" data-scroll-target="#lesson-overview"><span class="toc-section-number">2</span>  Lesson Overview</a></li>
  <li><a href="#the-topics-covered-briefly" id="toc-the-topics-covered-briefly" class="nav-link" data-scroll-target="#the-topics-covered-briefly"><span class="toc-section-number">3</span>  The topics covered, briefly</a></li>
  <li><a href="#lecture-notes" id="toc-lecture-notes" class="nav-link" data-scroll-target="#lecture-notes"><span class="toc-section-number">4</span>  Lecture Notes</a>
  <ul class="collapse">
  <li><a href="#diffedit-paper" id="toc-diffedit-paper" class="nav-link" data-scroll-target="#diffedit-paper"><span class="toc-section-number">4.1</span>  DiffEdit paper:</a></li>
  </ul></li>
  <li><a href="#takeaways-from-how-to-read-a-paper" id="toc-takeaways-from-how-to-read-a-paper" class="nav-link" data-scroll-target="#takeaways-from-how-to-read-a-paper"><span class="toc-section-number">5</span>  Takeaways from how to read a paper:</a></li>
  <li><a href="#notebook-from-foundations-2" id="toc-notebook-from-foundations-2" class="nav-link" data-scroll-target="#notebook-from-foundations-2"><span class="toc-section-number">6</span>  Notebook From Foundations 2</a></li>
  <li><a href="#elementwise-ops" id="toc-elementwise-ops" class="nav-link" data-scroll-target="#elementwise-ops"><span class="toc-section-number">7</span>  Elementwise Ops:</a></li>
  <li><a href="#broadcasting" id="toc-broadcasting" class="nav-link" data-scroll-target="#broadcasting"><span class="toc-section-number">8</span>  Broadcasting</a></li>
  <li><a href="#links" id="toc-links" class="nav-link" data-scroll-target="#links"><span class="toc-section-number">9</span>  Links</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="intro" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Intro</h1>
<p>(This post is in progress) The eleventh lesson of fast.ai.</p>
</section>
<section id="lesson-overview" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Lesson Overview</h1>
<p>The course may overrun (far) further than the original intended 8 lessons</p>
</section>
<section id="the-topics-covered-briefly" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> The topics covered, briefly</h1>
</section>
<section id="lecture-notes" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Lecture Notes</h1>
<p>Changing the prediction equation relying on the guidance parameter to be normalised between 0 and 1 improves the image quality! Sometimes it helps a lot. We can rescale the pred to improve image quality, we can rescale the difference between the vectors too to get a different generated image.</p>
<p>Another idea: why not lower the guidance_scale value over time? So at the start, to tell the model what image it needs to draw, we have guidance, but afterwards we need less. This helps too!</p>
<section id="diffedit-paper" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="diffedit-paper"><span class="header-section-number">4.1</span> DiffEdit paper:</h2>
<p>arxiv is a preprint paper, so it contains papers before they gave been prereviewed. Regardless they are useful because you can test the concepts and code yourself, and on forums people discuss it. Waiting until peer review takes too long.</p>
<p>Zotero is free software. You can download papers to Zotero. We can open the paper in Zotero. It’s better because we can annotate, tag them, edit them, sort them etc.</p>
<p>Reading papers is hard. The goal isn’t to understand the entire paper, just the basic ideas so that we can look at the code to see how it matches, and so how we can write our own code to understand it.</p>
<p>Start with the abstract. It uses text-condition diffusion, so what we’ve being doing. Semantic image editing is image generation where the generated image is as similar as possible to a given input image.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2022-10-25-L11.md_files/figure-html/image.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>Currently techniques required you to draw a mask (the part around the thing to change). This paper generates the mask for you!</p>
<p>Papers are full of citations. Don’t read all of them, every paper will have more citations to read.</p>
<p>If we want to turn a dog into a cat, we want to keep the pose and positioning. Older papers used a mask to delete the area and regenerate, but this paper attempts to keep pose and positioning.</p>
<p>Read references, examples, abstract. Often skip straight to experiments. Do this so you can see the aim of the paper. You need to know the aim to understand the paper.</p>
<p>The related work section is important to study if you want to do a deep dive. There’s a lot of repetition in the paper on the papers cited and that’s fine to skip. The end part of related work is normally most interesting. If you wanted to do the best possible to get the best ideas, spending ages on related work is important.</p>
<p>The background section. This section is often the scariest. It’s the maths behind how the model works. Noone in the world looks at the background and gets it. First youd need to know DDPM, and spend ages reading it. After that, then it makes sense. The background is meant to be a reminder of something you already know, not a place to learn it from scratch. Every diffusion paper has these equations, and lesson 9B covers them properly. The background is often read last and to look cool for reviewers. The main goal of reading it is to know the symbol’s definitions so that you can understand them later.</p>
<p>How to read this? Jeremy first recommends to learn the greek alphabet.</p>
<p><span class="math inline">\(\epsilon\)</span></p>
<p>L is for the loss function. How to understand what some symbols mean? We can use a program called mathpix. You select anything in your screen, and it turns it into latex! But mathpix is very expensive, but pix2tex is free!</p>
<p>This is good because latex is written as searchable text, put it into google. We can also download the other formats of our paper. We can download source to download the original latex document and look at that too.</p>
<p>And Detexify lets you draw a symbol to tell you what it is in latex.</p>
<p>The L2 norm gives the subscript 2. We have a subscript 2 for L2 norm, and a top 2 for squared. The entire thing in the modulus just turns into Sigma(x^2)!</p>
<p>Trying to find what E is!</p>
<p>Looking at the latex paper file:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2022-10-25-L11.md_files/figure-html/image.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>mathbb{E} we can google! It’s the expected value operator. Expected value is a weighted average. It’s Sum (prob*value) to give the average result.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2022-10-25-L11.md_files/figure-html/image.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>epislon is distributed normally with I, the identity (look lesson 9b), but episilon 0 is a noise estimator.</p>
<p>Looking at the equation: We have the noise, the prediction of it. Subtact them, square it, and find the expected value. This is all just the mean squared error. The loss function is just the mean squared error…</p>
<p>We reduce the value of each pixel and add noise to each pixel. And this goes so on.</p>
<p>Once you understand what you’re looking for, the equations make sense. Remember this is a background section. It tells us what is already there and what they changed.</p>
<p>What we’d find is that none of the further background matters. There’s only a subsection of the background we need to understand for our purposes. You don’t need to read the whole thing.</p>
<p><img src="2022-10-25-L11.md_files/figure-html/image.png" class="img-fluid" alt="image.png"> means nothing (unconditional, no prompt, ““)</p>
<p>The diagram explaning it is often the best part of the paper.</p>
<p>Step 1: We make a mask based on the difference between the denoising of the original prompt (zebra) and the denoising on a new prompt (horse). Step 2: Take the Horse, add noise to it. Step 3: During inference, while we turn the noised horse, we make the background stay the same.</p>
<p>Theoretical analysis part Jeremy skips. People add this to get past review. This is proving why this method is better than others.</p>
<p>Experimentation setup shows us what datasets they used and so on. They use metrics like CSFID and FID. We don’t usually care either. They do because they want to publish papers and good metrics prove themselves.</p>
<p>But here we find some examples. Very cool to see and also lets you understand how good and bad the technique is in certain areas.</p>
<p>Limitation we realised: If you cant come up with a mask to change your image, it won’t work. A bowl of fruits to a bowl of fruits purple tinged photo. We can’t do this because it requires changing the entire image, but our masks only cover the core subject.</p>
<p>Conclusion almost never adds anything ontop of what we’ve already read.</p>
<p>Often however, the ammendixes are itneresting for more examples. Often some of the most interesting examples are there.</p>
<p>It’s important to remember, this wasn’t a carefully chosen paper, it was just the most interesting paper this week. This is how reading papers is like. The big stretch/homework is to try and implement some of this paper. To do it, lesson 9 contains what you need.</p>
<p>To find good papers, follow akaliz on twitter. pretty much everybody does this.</p>
</section>
</section>
<section id="takeaways-from-how-to-read-a-paper" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Takeaways from how to read a paper:</h1>
</section>
<section id="notebook-from-foundations-2" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Notebook From Foundations 2</h1>
<p>Now we need to do matrix multiplication because we have tensors ready. Matrix multiplication is row by column. We do it for every element pair row column and that gives us one value. We do this for the entire matrix.</p>
<p>We do a minibatch: 5 images multiplied by the weights matrix.</p>
<p>We want to get the dimensions from the minibatch image store m1 and the weights.</p>
<p>Our resultant tensor is 5x10. This is from 5x784 by 784x10, the outer numbers.</p>
<p>We have a loop in a loop in a loop. This works, but is very very slow.</p>
<p>We change the print options to make it easier to read. Put this at the top of your notebooks, with numpy too.</p>
<p>One all the different cells work properly, select them all, copy and paste them, merge them, and turn them into a function. Still keep the old cells though, makes learning/testing easier.</p>
<p>This took half a second, very very long.</p>
<p>Numba takes Python, and turns it into machine code. It’s very easy to use! Write at-njit at the start of a function. Numba only works with numpy, so we use arrays instead of tensors.</p>
<p>Try a dot product, it taks 1/5th of a sec, because it has to compile and run. The second time, it only takes 21 microsecs, because it just has to call, not compile. With numba, we get python to run at c speed!</p>
<p>We now can replace one of our loops in our loop loop loop function with a dot product compiled c call.</p>
<p>test_close checks if two things give similar results. two functions.</p>
<p>now we try matmul again, and it’s about 2000 times faster just by changing one loop with numba!</p>
</section>
<section id="elementwise-ops" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Elementwise Ops:</h1>
<p>Again we’re using APL. It can teach you a lot about programming.</p>
<p>a &lt; b is elementwise comparison. it returns 0 and 1 for false and true.</p>
<p>to print easily after writing something, just put it m = …, then next line m.</p>
<p>Frobenius norm: The sum of every element squared, square rooted. it’s just m<em>m.sum().sqrt, because m</em>m is elementwise multiplication.</p>
<p>For a scalar, the norm is the same as the absolute value. You can index into matrices. m[2,:], is every column, row 2 m[:,2] is every row, column 2</p>
<p>we can just leave out the :</p>
<p>we can remove one of the matul lines since it’s just elementwise multplication. It’s a bit lower than our c code, but more general so good.</p>
</section>
<section id="broadcasting" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Broadcasting</h1>
<p>For arrays with different shapes. We can do any operation with a scalar to do it elementwise.</p>
</section>
<section id="links" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Links</h1>
<ul>
<li>As I am doing this lesson as it is released privately live, I cannot share links to the resources.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>