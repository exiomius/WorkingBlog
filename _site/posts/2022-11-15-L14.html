<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Adnan Jinnah">
<meta name="dcterms.date" content="2022-11-15">

<title>RvCode - fast.ai Lesson 14</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">RvCode</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/exiomius/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">fast.ai Lesson 14</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">fastai</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Adnan Jinnah </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 15, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro"><span class="toc-section-number">1</span>  Intro</a></li>
  <li><a href="#lesson-overview" id="toc-lesson-overview" class="nav-link" data-scroll-target="#lesson-overview"><span class="toc-section-number">2</span>  Lesson Overview</a></li>
  <li><a href="#lecture-notes" id="toc-lecture-notes" class="nav-link" data-scroll-target="#lecture-notes"><span class="toc-section-number">3</span>  Lecture Notes</a></li>
  <li><a href="#links" id="toc-links" class="nav-link" data-scroll-target="#links"><span class="toc-section-number">4</span>  Links</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="intro" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Intro</h1>
<p>The fourteenth lesson of fast.ai.</p>
</section>
<section id="lesson-overview" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Lesson Overview</h1>
</section>
<section id="lecture-notes" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Lecture Notes</h1>
<p>Last time we implemented the chain rule in neural network training in back propagation. There’s a really good explanation to help with last week! In lesson 13’s resources.</p>
<p>Jeremy reexplaining lin_grad: A loss function L is applied to the output of the neural network. L(n(w,x)) To update the weights, we need to know how loss changes w.r.t weights. To calculate this, let’s rewrite L. Call N=n(w,x). So L(N). We can write our derivatives as: <img src="2022-11-15-L14_files/figure-html/image.png" class="img-fluid" alt="Derivatives.png"></p>
<p>out.g contains the first derivative on the RHS.</p>
<p>We can write out the derivatives of the loss w.r.t the input: <img src="2022-11-15-L14_files/figure-html/image.png" class="img-fluid" alt="Inputs.png"></p>
<p>It matches onto this line of code, literally. inp.g = LHS. The confusing part is, the dN/dx on the RHS is equal to w.t(), the weights themselves. In other words, the output of the neural network w.r.t to it’s inputs depends on the weights, which makes sense!</p>
<p>And the middle line of code matches perfectly too! <img src="2022-11-15-L14_files/figure-html/image.png" class="img-fluid" alt="grad.png"></p>
<p>Last week, with all our code from scratch we got 97% accuracy! Albeit on training data.</p>
<p>With a format specifier we can write .2f to say, write it in 2 floating points. Python f strings are really helpful.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2022-11-15-L14_files/figure-html/image.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>Let’s refactoring our code. Making it cleaner and more consise. Pytorch feature. Submodel nn, the Module class. We can create a instance of the Module class, then assign a linear layer as an attribute to it. A module contains a linear layer called ‘foo’. Show me the parameters of Module. 4x3 tensor, and [4] biases. Somehow, just creating Module, and asking module, did all of this cool stuff.</p>
<p>ml.named_children() is a kind of iterator called a generator. Putting a list() around it runs it for us.</p>
<p>We look at our own MLP class implementation. MLP is just a forwards pass?</p>
<p>For MLP, we don’t need <strong>call</strong>, because we refactored or something last week, we use def forward instead.</p>
<p>The key thing is MLP knows the layers (attributes) and weights (parameters)!</p>
<p>This is important because we can refactor our training code! Specifically the part where weights are updated. Just two lines of code changing. Our fit function is a lot cooler now! But how did our class know what the layers and parameters are automatically? Because of a trick called <strong>setattr</strong>. In <strong>init</strong> we create a dictionary for each layer. Then we defined <strong>setattr</strong>, this is called automatically by Python everytime you define an attribute (e.g.&nbsp;self.l1). We check it doesn’t start with an _ (that’s used to private stuff?). If it doesn’t, then, store it in the dictionary. Then use super to call whatever is in the superclass, the base class. What is super calling here, because there is no base (inheirted) class? If you create a class and don’t put any brackets, e.g.&nbsp;MyModule() or MyModule. It’s a shortcut to writing MyModule(object). Python has things in object to do normal object things. super is using one of them.</p>
<p>But how does it do we just write model on a single line and it prints? It uses <strong>repr</strong></p>
<p>How did parameters work? Go through each module, go through each value, value is an actual layer. For each layer, then go through each parameter and yield p, an iterator. Now we can use p to call them out.</p>
<p>Advanced python if you want:</p>
<p>There’s no need to loop through a list or generator or iterator and yield. for p in l.parameters(): yield p.</p>
<p>Instead, a shortcut. Just yield from l.parameters() meaning ‘yield one at a time, everything from here’.</p>
<p>Now we know how to use nn.module, so let’s use Pytorches! How do we create the model that we stayed with, where we have our self.layers when we can register multiple layers at once using a list [nn.linear,nn.relu etc].</p>
<p>So we create a new Model class. We store the layers. Then we loop through them and call self.add_module to add them.</p>
<p>Again, <strong>call</strong> is def forward now. Now we can register multiple layers at a time. nn.ModuleList does this for us.</p>
<p>Again, SequentialModel should have forward instead of <strong>call</strong> In forward, we just get the result from each layer.</p>
<p>A cooler way to doing something. Using reduce: <img src="2022-11-15-L14_files/figure-html/image.png" class="img-fluid" alt="image.png"></p>
<p>Is the same as</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2022-11-15-L14_files/figure-html/image.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>Reduce is a reduction, a funmental cs concept. A reduction starts with an initial value. It’s the third parameter, x. Then the second parameter is looped through and the first parameter called each time. Loop through a sequence, each of our layers. For each layer, call a function, the first parameter, “lambda val,layer: layer(val)”. The first time around the function is passed x with the first layer. The second time it takes the output of the first function pass, and passes that and the second layer. Essentially the first loop takes x and the linear layer, and the second takes the output from the linear layer, and ReLU.</p>
<p>A reduction is talked about a lot in papers and books as a general concept. There’s no explicit loop althrough it occurs internally.</p>
<p>To continue cleaning up our training code, we create a new class. An optimiser class automatates parameters with the parameters and learning rate. p.grad.data.zero_() is the same as torch.nograd We pass it the parameters to optimise and the learning rate. It stores them. Specifically the parameters might be a generator so we use list() on em!</p>
<p>We create opt with mode.parameters nn.Module makes for us. Now we create our new loop! just opt.step() and opt.zero_grad().</p>
<p>An SGD optimiser isn’t actually much code at all! If you’re having trouble understanding a framework, doing it all from scratch will really clear it up.</p>
<p>get_model() returns a model and it’s optimiser. And now our training code for torch’s optimiser.</p>
<p>Further simpler still! The Dataset class. We pass in our independent and dependent variable and store len. <strong>len</strong> allows len to work <strong>getitem</strong> is called whenever you use square brackets [] in python. We return a tuple of the x and y values. Using assert to check lengths are the same.</p>
<p>Now for training loop, just clean up the dataset line.</p>
<p>Our using a data loader. We need an iterator. A class with a <strong>iter</strong> method. When you do for i in list, you actually are calling <strong>iter</strong> which loops through using yield.</p>
<p>A DataLoader has a dataset and a batch size we which store. When for call a for loop, we go through the dataset, skipping bs values, and yield the correct dataset slice.</p>
<p>Remember, the way to get one thing from a iterator is using iter. next() grabs one value from it.</p>
<p>Now simplifying fit using dataloaders to remove the explicit for loop. Now that our code is nice and concise, we can add features.</p>
<p>Instead of always making our dataset going in order. E.g. the dataset is 500 values, so the first epoch we do values 1-50, then second 51-100 etc. We want to randomise which values we do each epoch. Shuffle around the indexes of those 500 values.</p>
<p>We define Sampler to do so. We create a Sampler without Shuffle (w/o randomising), it simpty returns all the numbers from 0-n as an iterator. No order change. But with Shuffle=True, then it randomly shuffles those numbers.</p>
</section>
<section id="links" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Links</h1>
<ul>
<li>As I am doing this course as it is released privately live, I cannot share links to the lesson.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>